<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gallery Batch Uploader</title>
    <style>
        :root { --primary: #000; --bg: #f5f5f7; --card-bg: #fff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 40px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .upload-section { background: var(--card-bg); padding: 40px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); text-align: center; margin-bottom: 40px; }
        .upload-box { border: 2px dashed #ddd; border-radius: 12px; padding: 40px; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; }
        .upload-box:hover { border-color: #999; background: #fafafa; }
        
        /* é¢„è§ˆç”»å¸ƒå®¹å™¨ */
        #preview-canvas-container { width: 150px; height: 150px; border-radius: 8px; overflow: hidden; background: #eee; margin-bottom: 15px; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        button.btn-primary { background: var(--primary); color: white; border: none; padding: 12px 30px; border-radius: 30px; font-size: 16px; cursor: pointer; margin-top: 20px; transition: transform 0.2s; }
        button.btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        
        .progress-container { width: 100%; max-width: 400px; margin: 20px auto 0; text-align: left; display: none; }
        .progress-bar-bg { width: 100%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .progress-bar-fill { height: 100%; background: #4CAF50; width: 0%; transition: width 0.3s; }
        .progress-text { font-size: 12px; color: #666; display: flex; justify-content: space-between; margin-top: 5px; }

        .gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .card { background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.03); transition: transform 0.2s; position: relative; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        .card-thumb { width: 100%; height: 200px; background: #f9f9f9; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .card-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .no-thumb { font-size: 40px; color: #ddd; }
        .card-info { padding: 15px; }
        .card-title { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .delete-btn { position: absolute; top: 10px; right: 10px; background: rgba(255,0,0,0.8); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
        .card:hover .delete-btn { opacity: 1; }
        #status { margin-top: 10px; color: #666; font-size: 14px; font-weight: 500; }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="upload-section">
            <h1>ğŸ›ï¸ Batch Asset Uploader</h1>
            <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                <div id="preview-canvas-container"></div>
                <div id="upload-text">
                    <span style="font-size: 40px;">ğŸ“¦</span><br>
                    <span id="fileName">Click to Select Multiple .glb Files</span>
                </div>
                <input type="file" id="fileInput" accept=".glb, .gltf" multiple style="display: none" onchange="handleFileSelect(this)">
            </div>
            
            <div class="progress-container" id="progressBox">
                <div id="progressLabel">Preparing...</div>
                <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressBar"></div></div>
                <div class="progress-text">
                    <span id="progressCount">0/0</span>
                    <span id="progressPercent">0%</span>
                </div>
            </div>

            <div id="status">Ready</div>
            <button class="btn-primary" id="saveBtn" onclick="processBatchUpload()" disabled>Upload All Files</button>
        </div>

        <div class="gallery-header">
            <h2>Collection Library</h2>
            <span id="count-badge" style="background:#eee; padding:5px 10px; border-radius:20px; font-size:12px;">Loading...</span>
        </div>
        <div class="grid" id="gallery-grid"></div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js'; // æ”¯æŒå‹ç¼©æ¨¡å‹çš„ç¼©ç•¥å›¾ç”Ÿæˆ
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // ==========================================
        // TODO: ç²˜è´´ä½ çš„ firebaseConfig
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAl_IaEOIKzrnulRN6j0pn0uN_aJFdAPOc",
            authDomain: "online-white-box.firebaseapp.com",
            projectId: "online-white-box",
            storageBucket: "online-white-box.firebasestorage.app",
            messagingSenderId: "227799896378",
            appId: "1:227799896378:web:94e416ee99d0e720e18003",
            measurementId: "G-G2ZWQZ8W8F"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Three.js å…¨å±€å˜é‡ (ç”¨äºå¤ç”¨ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼)
        let scene, camera, renderer, loader;
        
        window.handleFileSelect = handleFileSelect;
        window.processBatchUpload = processBatchUpload;
        window.deleteModel = deleteModel;

        let selectedFiles = [];
        
        initThreeJS();
        loadGalleryGrid();

        function initThreeJS() {
            const width = 150, height = 150;
            const container = document.getElementById('preview-canvas-container');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf5f5f7);
            
            const ambient = new THREE.AmbientLight(0xffffff, 1.5);
            scene.add(ambient);
            const dirLight = new THREE.DirectionalLight(0xffffff, 2.0);
            dirLight.position.set(5, 10, 7);
            scene.add(dirLight);

            camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
            renderer.setSize(width, height);
            container.appendChild(renderer.domElement);

            loader = new GLTFLoader();
            const dracoLoader = new DRACOLoader();
            dracoLoader.setDecoderPath('https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/');
            loader.setDRACOLoader(dracoLoader);
        }

        function handleFileSelect(input) {
            if (input.files && input.files.length > 0) {
                // å°† FileList è½¬ä¸ºæ•°ç»„
                selectedFiles = Array.from(input.files);
                
                document.getElementById('fileName').innerText = `${selectedFiles.length} Files Selected`;
                document.getElementById('status').innerText = "Ready to start batch upload.";
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('saveBtn').innerText = `Upload ${selectedFiles.length} Files`;
                
                // éšè—å ä½ç¬¦ï¼Œæ˜¾ç¤ºé¢„è§ˆæ¡†å‡†å¤‡ç»™ç”¨æˆ·çœ‹åŠ¨ç”»
                document.getElementById('upload-text').style.display = 'block';
                document.getElementById('preview-canvas-container').style.display = 'block';
            }
        }

        // === æ ¸å¿ƒé€»è¾‘ï¼šæ‰¹é‡å¤„ç†é˜Ÿåˆ— ===
        async function processBatchUpload() {
            if (selectedFiles.length === 0) return;

            const btn = document.getElementById('saveBtn');
            const status = document.getElementById('status');
            const pBox = document.getElementById('progressBox');
            const pBar = document.getElementById('progressBar');
            const pLabel = document.getElementById('progressLabel');
            const pCount = document.getElementById('progressCount');
            const pPercent = document.getElementById('progressPercent');

            btn.disabled = true;
            pBox.style.display = 'block';
            document.getElementById('upload-text').style.display = 'none'; // éšè—æ–‡å­—ï¼Œåªçœ‹å›¾

            let successCount = 0;
            let failCount = 0;

            // éå†æ–‡ä»¶æ•°ç»„
            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const currentIndex = i + 1;
                const total = selectedFiles.length;

                // æ›´æ–° UI
                pLabel.innerText = `Processing: ${file.name}`;
                pCount.innerText = `${currentIndex}/${total}`;
                const overallPercent = ((i / total) * 100).toFixed(0);
                pPercent.innerText = `${overallPercent}%`;
                pBar.style.width = `${overallPercent}%`;
                status.innerText = `Analyzing model ${currentIndex} of ${total}...`;

                try {
                    // 1. ç”Ÿæˆç¼©ç•¥å›¾ (è¿™é‡Œä¼šæ›´æ–°é¢„è§ˆç”»å¸ƒ)
                    const thumbBlob = await generateThumbnailPromise(file);

                    // 2. ä¸Šä¼ æ–‡ä»¶
                    status.innerText = `Uploading ${file.name}...`;
                    await uploadSingleFile(file, thumbBlob);
                    
                    successCount++;

                } catch (err) {
                    console.error(`Failed to upload ${file.name}:`, err);
                    failCount++;
                }
            }

            // å…¨éƒ¨å®Œæˆ
            pBar.style.width = '100%';
            pPercent.innerText = '100%';
            status.innerText = `ğŸ‰ Done! Success: ${successCount}, Failed: ${failCount}`;
            btn.innerText = "Upload Complete";
            
            setTimeout(() => {
                resetUI();
            }, 3000);
        }

        // è¾…åŠ©å‡½æ•°ï¼šå°†æ—§çš„å›è°ƒå¼ generateThumbnail åŒ…è£…æˆ Promise
        function generateThumbnailPromise(file) {
            return new Promise((resolve, reject) => {
                const url = URL.createObjectURL(file);
                
                // æ¸…ç†åœºæ™¯ä¸­æ—§æ¨¡å‹
                const oldModel = scene.children.find(c => c.type === 'Group' || c.type === 'Object3D'); // ç®€æ˜“æ¸…ç†
                if(oldModel) scene.remove(oldModel);
                
                // ä¸ºäº†é¿å… scene.children æ¸…ç†ä¸å¹²å‡€ï¼Œæˆ‘ä»¬æŠŠ lights ä¿æŒä½ï¼Œåªç§»é™¤ mesh
                scene.traverse((child) => {
                    if (child.isMesh) {
                        child.geometry.dispose();
                        if(child.material) child.material.dispose();
                    }
                });
                // é‡æ–°æ¸…ç©ºï¼ˆé™¤äº†ç¯å…‰ï¼‰å¤ªéº»çƒ¦ï¼Œæˆ‘ä»¬ç›´æ¥æŠŠ Scene é™¤äº†ç¯å…‰å¤–çš„ Group ç§»èµ°
                // ç®€å•ç‚¹ï¼šé‡æ–°å»ºä¸ª Scene? ä¸ï¼Œå¤ç”¨æ€§èƒ½æ›´å¥½ã€‚
                // æˆ‘ä»¬ç›´æ¥åŠ è½½ï¼ŒåŠ è½½å®ŒæŠŠæ–°æ¨¡å‹ add è¿›å»ï¼Œæˆªå›¾å®Œå† removeã€‚

                loader.load(url, (gltf) => {
                    const model = gltf.scene;

                    // è®¡ç®—åŒ…å›´ç›’å¹¶å±…ä¸­
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());

                    model.position.x = -center.x;
                    model.position.y = -center.y;
                    model.position.z = -center.z;
                    
                    scene.add(model);

                    // è°ƒæ•´ç›¸æœº
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const fov = camera.fov * (Math.PI / 180);
                    let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
                    cameraZ *= 1.5;
                    
                    camera.position.set(0, size.y * 0.2, cameraZ);
                    camera.lookAt(0, 0, 0);

                    // æ¸²æŸ“å¹¶æˆªå›¾
                    // ç¨å¾®å»¶æ—¶ä¸€å¸§ç¡®ä¿æè´¨åŠ è½½
                    setTimeout(() => {
                        renderer.render(scene, camera);
                        renderer.domElement.toBlob((blob) => {
                            // æ¸…ç†
                            scene.remove(model);
                            URL.revokeObjectURL(url);
                            resolve(blob);
                        }, 'image/jpeg', 0.8);
                    }, 50);

                }, undefined, (err) => {
                    URL.revokeObjectURL(url);
                    // å³ä½¿ç¼©ç•¥å›¾ç”Ÿæˆå¤±è´¥ï¼Œä¹Ÿå…è®¸ç»§ç»­ä¸Šä¼ æ¨¡å‹ï¼Œåªæ˜¯æ²¡æœ‰å›¾
                    console.warn("Thumb gen failed", err);
                    resolve(null); 
                });
            });
        }

        // è¾…åŠ©å‡½æ•°ï¼šä¸Šä¼ å•ä¸ªæ–‡ä»¶çš„å®Œæ•´æµç¨‹
        async function uploadSingleFile(file, thumbBlob) {
            const timestamp = Date.now();
            // åŠ ä¸ªéšæœºæ•°é˜²æ­¢æ‰¹é‡ä¸Šä¼ æ—¶æ—¶é—´æˆ³æ’è½¦
            const randomId = Math.floor(Math.random() * 1000); 
            const modelName = `${timestamp}_${randomId}_${file.name}`;
            const thumbName = `${timestamp}_${randomId}_thumb.jpg`;

            // A. ä¸Šä¼ æ¨¡å‹
            const modelRef = ref(storage, 'library/' + modelName);
            // è¿™é‡Œæˆ‘ä»¬ä¸éœ€è¦ uploadTask çš„è¿›åº¦æ¡äº†ï¼Œå› ä¸ºæˆ‘ä»¬æœ‰æ€»è¿›åº¦æ¡
            const modelSnapshot = await uploadBytesResumable(modelRef, file);
            const modelUrl = await getDownloadURL(modelSnapshot.ref);

            // B. ä¸Šä¼ ç¼©ç•¥å›¾ (å¦‚æœæœ‰)
            let thumbUrl = null;
            let thumbPath = null;
            if (thumbBlob) {
                const thumbRef = ref(storage, 'library_thumbs/' + thumbName);
                const thumbSnapshot = await uploadBytesResumable(thumbRef, thumbBlob);
                thumbUrl = await getDownloadURL(thumbSnapshot.ref);
                thumbPath = thumbRef.fullPath;
            }

            // C. å†™å…¥æ•°æ®åº“
            await addDoc(collection(db, "model_library"), {
                name: file.name,
                url: modelUrl,
                thumbnailUrl: thumbUrl,
                thumbPath: thumbPath,
                storagePath: modelRef.fullPath,
                uploadDate: new Date(),
                active: true
            });
        }

        function resetUI() {
            selectedFiles = [];
            document.getElementById('fileName').innerText = "Click to Select Multiple .glb Files";
            document.getElementById('progressBox').style.display = 'none';
            document.getElementById('preview-canvas-container').style.display = 'none';
            document.getElementById('upload-text').style.display = 'block';
            document.getElementById('saveBtn').disabled = true;
            document.getElementById('saveBtn').innerText = "Upload All Files";
            document.getElementById('status').innerText = "Ready";
            document.getElementById('fileInput').value = ''; // æ¸…ç©º input
        }

        function loadGalleryGrid() {
            const grid = document.getElementById('gallery-grid');
            const q = query(collection(db, "model_library"), orderBy("uploadDate", "desc"));

            onSnapshot(q, (snapshot) => {
                grid.innerHTML = '';
                document.getElementById('count-badge').innerText = `${snapshot.size} items`;
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const card = document.createElement('div');
                    card.className = 'card';
                    const thumbContent = data.thumbnailUrl ? `<img src="${data.thumbnailUrl}">` : `<div class="no-thumb">ğŸ§Š</div>`;
                    card.innerHTML = `
                        <button class="delete-btn" onclick="deleteModel('${docSnap.id}', '${data.storagePath}', '${data.thumbPath}')">Ã—</button>
                        <div class="card-thumb">${thumbContent}</div>
                        <div class="card-info"><div class="card-title" title="${data.name}">${data.name}</div></div>
                    `;
                    grid.appendChild(card);
                });
            });
        }

        async function deleteModel(docId, storagePath, thumbPath) {
            if (!confirm("Delete this model?")) return;
            try {
                await deleteDoc(doc(db, "model_library", docId));
                if (storagePath) await deleteObject(ref(storage, storagePath)).catch(e=>{});
                if (thumbPath) await deleteObject(ref(storage, thumbPath)).catch(e=>{});
            } catch (e) { alert(e.message); }
        }
    </script>
</body>
</html>