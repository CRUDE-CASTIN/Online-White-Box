<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VOID ARCHIVE // CONSOLE</title>
    <style>
        :root { 
            --bg: #f2f2f2; 
            --surface: #ffffff; 
            --line: #e0e0e0; 
            --text-main: #111; 
            --text-dim: #888;
            --accent: #000;
            --alert: #ff3b30;
        }
        
        * { box-sizing: border-box; }
        body { 
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text-main); 
            margin: 0; padding: 0; 
            height: 100vh; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
        }

        /* === 1. 顶部仪表盘 (Analytics Dashboard) === */
        header {
            background: var(--surface);
            border-bottom: 1px solid var(--line);
            padding: 0 30px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .brand { font-weight: 700; letter-spacing: -0.5px; font-size: 18px; }
        
        .metrics { display: flex; gap: 40px; height: 100%; align-items: center; }
        .metric-item { display: flex; flex-direction: column; justify-content: center; min-width: 120px; }
        .metric-label { font-size: 10px; text-transform: uppercase; color: var(--text-dim); letter-spacing: 1px; margin-bottom: 4px; }
        .metric-value { font-family: 'Courier New', monospace; font-weight: 700; font-size: 16px; }
        
        /* 进度条样式 */
        .progress-track { width: 100%; height: 4px; background: #eee; margin-top: 4px; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.5s ease; }
        .progress-fill.warning { background: #ffcc00; }
        .progress-fill.danger { background: var(--alert); }

        /* === 2. 主体布局 (Split View) === */
        main { display: flex; flex: 1; overflow: hidden; }

        /* 左侧：网格列表 + 上传 */
        .library-panel {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            border-right: 1px solid var(--line);
        }

        /* 上传区域 (更加紧凑) */
        .upload-compact {
            background: var(--surface);
            border: 1px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
            cursor: pointer;
        }
        .upload-compact:hover { border-color: #666; background: #fff; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .upload-status { font-size: 13px; color: var(--text-dim); }
        .btn-upload { background: var(--accent); color: #fff; border: none; padding: 8px 20px; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .btn-upload:disabled { background: #ccc; cursor: not-allowed; }

        /* 网格 */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }
        .grid-item {
            background: var(--surface);
            border: 1px solid transparent;
            aspect-ratio: 1;
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        .grid-item:hover { border-color: #999; }
        .grid-item.selected { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent); }
        .grid-item img { width: 100%; height: 100%; object-fit: cover; }
        .grid-item .no-thumb { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #eee; color: #ccc; font-size: 24px; }
        
        /* 状态标记 */
        .status-dot { position: absolute; top: 8px; left: 8px; width: 8px; height: 8px; border-radius: 50%; }
        .status-dot.pinned { background: var(--alert); box-shadow: 0 0 4px rgba(255, 59, 48, 0.5); }

        /* === 3. 右侧：检查器 (Inspector) === */
        .inspector-panel {
            width: 360px;
            background: var(--surface);
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        
        .inspector-empty { color: var(--text-dim); font-size: 14px; text-align: center; margin-top: 100px; }
        
        /* 检查器内容 */
        .preview-large {
            width: 100%;
            aspect-ratio: 1;
            background: #f9f9f9;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 20px;
            border: 1px solid var(--line);
            display: flex; align-items: center; justify-content: center;
        }
        .preview-large img { width: 100%; height: 100%; object-fit: contain; }

        .meta-group { margin-bottom: 25px; }
        .meta-label { font-size: 10px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .meta-value { font-size: 14px; font-weight: 500; word-break: break-all; font-family: 'Helvetica Neue', sans-serif; }
        .meta-value.mono { font-family: 'Courier New', monospace; }
        .art-title { font-family: 'Helvetica Neue', sans-serif; font-weight: 700; font-size: 24px; line-height: 1.2; margin-bottom: 5px; }

        /* 检查器按钮组 */
        .action-group { display: flex; gap: 10px; margin-top: auto; padding-top: 20px; border-top: 1px solid var(--line); }
        .btn-action { flex: 1; padding: 12px; border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer; text-align: center; transition: all 0.2s; }
        
        .btn-pin { background: var(--surface); border: 1px solid var(--line); color: var(--text-main); }
        .btn-pin:hover { border-color: #000; }
        .btn-pin.active { background: var(--text-main); color: #fff; border-color: var(--text-main); }
        
        .btn-download { background: var(--surface); border: 1px solid var(--line); color: var(--text-main); }
        .btn-download:hover { background: #f0f0f0; }

        .btn-delete { background: #fff0f0; border: 1px solid #ffcccc; color: var(--alert); }
        .btn-delete:hover { background: var(--alert); color: white; border-color: var(--alert); }

        /* 隐藏的上传辅助 */
        #preview-canvas-container { display: none; }
        #upload-progress-overlay { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #000; color: white; padding: 10px 20px; border-radius: 30px; font-size: 12px; display: none; box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 100; }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <header>
        <div class="brand">VOID ARCHIVE <span style="font-weight:400; color:#888;">// MANAGER</span></div>
        <div class="metrics">
            <div class="metric-item">
                <div class="metric-label">Total Assets</div>
                <div class="metric-value" id="stat-count">0</div>
            </div>
            <div class="metric-item" style="width: 150px;">
                <div class="metric-label">Storage Used (<span id="stat-size-text">0 MB</span> / 5 GB)</div>
                <div class="progress-track"><div class="progress-fill" id="stat-storage-bar"></div></div>
            </div>
            <div class="metric-item">
                <div class="metric-label">Est. Bandwidth</div>
                <div class="metric-value" style="color:#aaa;">--</div> 
            </div>
        </div>
    </header>

    <main>
        <div class="library-panel">
            <div class="upload-compact" onclick="document.getElementById('fileInput').click()">
                <div>
                    <div style="font-weight:600; font-size:14px;">Import Models</div>
                    <div class="upload-status" id="upload-status">Supports .glb / .gltf (Multi-select)</div>
                </div>
                <button class="btn-upload" id="upload-btn">SELECT FILES</button>
                <input type="file" id="fileInput" accept=".glb, .gltf" multiple style="display: none" onchange="handleFileSelect(this)">
            </div>

            <div class="grid-container" id="gallery-grid">
                </div>
        </div>

        <div class="inspector-panel" id="inspector">
            <div class="inspector-empty">Select an asset to view details</div>
            </div>
    </main>

    <div id="preview-canvas-container"></div>
    <div id="upload-progress-overlay">Processing 1/5...</div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js'; 
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, query, orderBy, onSnapshot, updateDoc, getDocs, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // === Firebase Config ===
        const firebaseConfig = {
            apiKey: "AIzaSyAl_IaEOIKzrnulRN6j0pn0uN_aJFdAPOc",
            authDomain: "online-white-box.firebaseapp.com",
            projectId: "online-white-box",
            storageBucket: "online-white-box.firebasestorage.app",
            messagingSenderId: "227799896378",
            appId: "1:227799896378:web:94e416ee99d0e720e18003",
            measurementId: "G-G2ZWQZ8W8F"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let scene, camera, renderer, loader;
        let selectedFiles = [];
        let currentModels = []; // Store fetched data
        
        window.handleFileSelect = handleFileSelect;
        
        initThreeJS();
        initDataListener();

        // === 1. 初始化 ThreeJS (用于生成截图) ===
        function initThreeJS() {
            const width = 150, height = 150;
            const container = document.getElementById('preview-canvas-container');
            scene = new THREE.Scene(); scene.background = new THREE.Color(0xf5f5f7);
            scene.add(new THREE.AmbientLight(0xffffff, 1.5));
            const dirLight = new THREE.DirectionalLight(0xffffff, 2.0);
            dirLight.position.set(5, 10, 7); scene.add(dirLight);
            camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
            renderer.setSize(width, height);
            container.appendChild(renderer.domElement);
            loader = new GLTFLoader();
            const dracoLoader = new DRACOLoader();
            dracoLoader.setDecoderPath('https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/');
            loader.setDRACOLoader(dracoLoader);
        }

        // === 2. 命名生成器 (复制自前端，确保一致) ===
        function generateSystematicName(seed) {
            let hash = 0;
            if (!seed || seed.length === 0) return "NULL · 000 · Ø";
            for (let i = 0; i < seed.length; i++) { hash = ((hash << 5) - hash) + seed.charCodeAt(i); hash |= 0; }
            hash = Math.abs(hash);
            const prefixes = ["OBJ", "ARCH", "SYS", "NODE", "DATA", "CORE", "FLUX", "VOID", "UNIT", "SPEC", "FORM"];
            const symbols = ["α", "β", "γ", "δ", "ε", "ζ", "η", "θ", "ι", "κ", "λ", "μ", "Σ", "Ω", "Ø", "Δ"];
            const pIndex = hash % prefixes.length;
            const sIndex = (hash >> 3) % symbols.length;
            const charCode = String.fromCharCode(65 + (hash % 26)); 
            const num = (hash % 999).toString().padStart(3, '0'); 
            return `${prefixes[pIndex]} · ${charCode}${num} · ${symbols[sIndex]}`;
        }

        // === 3. 数据监听与仪表盘 ===
        function initDataListener() {
            const q = query(collection(db, "model_library"), orderBy("uploadDate", "desc"));
            onSnapshot(q, (snapshot) => {
                const grid = document.getElementById('gallery-grid');
                grid.innerHTML = '';
                currentModels = [];
                let totalBytes = 0;

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    data.id = doc.id; // Append ID
                    currentModels.push(data);
                    
                    // 计算存储大小 (如果数据里有size字段)
                    if(data.size) totalBytes += data.size;

                    const el = document.createElement('div');
                    el.className = `grid-item ${data.pinned ? 'pinned' : ''}`;
                    el.onclick = () => renderInspector(data);
                    
                    const thumb = data.thumbnailUrl ? `<img src="${data.thumbnailUrl}">` : `<div class="no-thumb">#</div>`;
                    const dot = data.pinned ? `<div class="status-dot pinned"></div>` : '';
                    
                    el.innerHTML = `${thumb}${dot}`;
                    grid.appendChild(el);
                });

                updateDashboard(currentModels.length, totalBytes);
            });
        }

        function updateDashboard(count, bytes) {
            document.getElementById('stat-count').innerText = count;
            
            // 格式化大小
            const mb = (bytes / (1024 * 1024)).toFixed(2);
            document.getElementById('stat-size-text').innerText = `${mb} MB`;
            
            // 计算进度 (5GB = 5120MB)
            const percent = Math.min((mb / 5120) * 100, 100);
            const bar = document.getElementById('stat-storage-bar');
            bar.style.width = `${percent}%`;
            
            if(percent > 80) bar.className = 'progress-fill warning';
            if(percent > 95) bar.className = 'progress-fill danger';
        }

        // === 4. 渲染检查器面板 ===
        function renderInspector(data) {
            const panel = document.getElementById('inspector');
            const sysName = generateSystematicName(data.name);
            const dateStr = data.uploadDate ? new Date(data.uploadDate.seconds * 1000).toLocaleDateString() : 'Unknown';
            const sizeStr = data.size ? (data.size / 1024 / 1024).toFixed(2) + ' MB' : 'Unknown';
            const thumb = data.thumbnailUrl ? `<img src="${data.thumbnailUrl}">` : `<div style="color:#ccc;">No Preview</div>`;
            const pinnedLabel = data.pinned ? "UNPIN ASSET" : "PIN TO DISPLAY";
            const pinnedClass = data.pinned ? "active" : "";

            panel.innerHTML = `
                <div class="preview-large">${thumb}</div>
                
                <div class="meta-group">
                    <div class="meta-label">Systematic ID</div>
                    <div class="art-title">${sysName}</div>
                </div>

                <div class="meta-group">
                    <div class="meta-label">Original Filename</div>
                    <div class="meta-value mono">${data.name}</div>
                </div>

                <div class="meta-group" style="display:flex; gap:20px;">
                    <div>
                        <div class="meta-label">File Size</div>
                        <div class="meta-value mono">${sizeStr}</div>
                    </div>
                    <div>
                        <div class="meta-label">Date Added</div>
                        <div class="meta-value mono">${dateStr}</div>
                    </div>
                </div>

                <div class="meta-group">
                    <div class="meta-label">Storage Path</div>
                    <div class="meta-value mono" style="font-size:10px; color:#999;">${data.storagePath}</div>
                </div>

                <div class="action-group">
                    <button class="btn-action btn-pin ${pinnedClass}" onclick="togglePin('${data.id}', ${data.pinned})">${pinnedLabel}</button>
                    <button class="btn-action btn-download" onclick="window.open('${data.url}')">DOWNLOAD</button>
                    <button class="btn-action btn-delete" onclick="deleteModel('${data.id}', '${data.storagePath}', '${data.thumbPath}')">DELETE</button>
                </div>
            `;
        }

        // === 5. 上传逻辑 (自动队列) ===
        function handleFileSelect(input) {
            if (input.files && input.files.length > 0) {
                const files = Array.from(input.files);
                processQueue(files);
            }
            input.value = '';
        }

        async function processQueue(files) {
            const overlay = document.getElementById('upload-progress-overlay');
            overlay.style.display = 'block';
            
            for (let i = 0; i < files.length; i++) {
                overlay.innerText = `Processing ${i+1}/${files.length}: ${files[i].name}`;
                try {
                    const thumbBlob = await generateThumbnailPromise(files[i]);
                    await uploadSingleFile(files[i], thumbBlob);
                } catch (e) {
                    console.error(e);
                }
            }
            
            overlay.innerText = "All Complete";
            setTimeout(() => { overlay.style.display = 'none'; }, 2000);
        }

        function generateThumbnailPromise(file) {
            return new Promise((resolve) => {
                const url = URL.createObjectURL(file);
                // 简易清理
                scene.children = scene.children.filter(c => c.isLight); // 只保留灯光
                
                loader.load(url, (gltf) => {
                    const model = gltf.scene;
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    model.position.sub(center); // Center
                    scene.add(model);

                    const maxDim = Math.max(size.x, size.y, size.z);
                    const fov = camera.fov * (Math.PI / 180);
                    let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2)) * 1.5;
                    camera.position.set(0, size.y * 0.2, cameraZ);
                    camera.lookAt(0, 0, 0);

                    setTimeout(() => {
                        renderer.render(scene, camera);
                        renderer.domElement.toBlob((blob) => {
                            URL.revokeObjectURL(url);
                            resolve(blob);
                        }, 'image/jpeg', 0.8);
                    }, 100); // Wait for render
                }, undefined, () => resolve(null));
            });
        }

        async function uploadSingleFile(file, thumbBlob) {
            const timestamp = Date.now();
            const randomId = Math.floor(Math.random() * 1000); 
            const modelName = `${timestamp}_${randomId}_${file.name}`;
            const thumbName = `${timestamp}_${randomId}_thumb.jpg`;

            const modelRef = ref(storage, 'library/' + modelName);
            const modelSnapshot = await uploadBytesResumable(modelRef, file);
            const modelUrl = await getDownloadURL(modelSnapshot.ref);

            let thumbUrl = null;
            let thumbPath = null;
            if (thumbBlob) {
                const thumbRef = ref(storage, 'library_thumbs/' + thumbName);
                const thumbSnapshot = await uploadBytesResumable(thumbRef, thumbBlob);
                thumbUrl = await getDownloadURL(thumbSnapshot.ref);
                thumbPath = thumbRef.fullPath;
            }

            // Save file size for analytics
            await addDoc(collection(db, "model_library"), {
                name: file.name,
                url: modelUrl,
                thumbnailUrl: thumbUrl,
                thumbPath: thumbPath,
                storagePath: modelRef.fullPath,
                uploadDate: new Date(),
                size: file.size, // Save Size!
                active: true,
                pinned: false
            });
        }

        // === 6. 功能函数 (Exposed to Window) ===
        window.togglePin = async (docId, currentStatus) => {
            const batch = writeBatch(db);
            if (!currentStatus) {
                // Pin logic: Unpin others first
                const pinnedQ = query(collection(db, "model_library"), where("pinned", "==", true));
                const pinnedDocs = await getDocs(pinnedQ);
                pinnedDocs.forEach(doc => { batch.update(doc.ref, { pinned: false }); });
                batch.update(doc(db, "model_library", docId), { pinned: true });
            } else {
                batch.update(doc(db, "model_library", docId), { pinned: false });
            }
            await batch.commit();
            // Refresh Inspector UI if needed? OnSnapshot will handle list, but Inspector might need manual update or re-select.
            // Simplified: Just allow OnSnapshot to update the grid dots.
        };

        window.deleteModel = async (docId, storagePath, thumbPath) => {
            if (!confirm("Permanently delete this asset?")) return;
            try {
                await deleteDoc(doc(db, "model_library", docId));
                if (storagePath) await deleteObject(ref(storage, storagePath)).catch(e=>{});
                if (thumbPath && thumbPath !== 'undefined') await deleteObject(ref(storage, thumbPath)).catch(e=>{});
                // Clear inspector
                document.getElementById('inspector').innerHTML = '<div class="inspector-empty">Select an asset to view details</div>';
            } catch (e) { alert(e.message); }
        };
    </script>
</body>
</html>