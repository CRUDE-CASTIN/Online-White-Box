<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gallery Asset Manager</title>
    <style>
        :root { --primary: #000; --bg: #f5f5f7; --card-bg: #fff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; padding: 40px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .upload-section { background: var(--card-bg); padding: 40px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); text-align: center; margin-bottom: 40px; }
        .upload-box { border: 2px dashed #ddd; border-radius: 12px; padding: 40px; cursor: pointer; transition: all 0.3s; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 200px; }
        .upload-box:hover { border-color: #999; background: #fafafa; }
        
        #preview-canvas-container { width: 150px; height: 150px; border-radius: 8px; overflow: hidden; background: #eee; margin-bottom: 15px; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        
        button.btn-primary { background: var(--primary); color: white; border: none; padding: 12px 30px; border-radius: 30px; font-size: 16px; cursor: pointer; margin-top: 20px; transition: transform 0.2s; }
        button.btn-primary:disabled { background: #ccc; cursor: not-allowed; transform: none; }
        
        .progress-container { width: 100%; max-width: 400px; margin: 20px auto 0; text-align: left; display: none; }
        .progress-bar-bg { width: 100%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .progress-bar-fill { height: 100%; background: #4CAF50; width: 0%; transition: width 0.3s; }
        .progress-text { font-size: 12px; color: #666; display: flex; justify-content: space-between; margin-top: 5px; }

        .gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .card { background: var(--card-bg); border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.03); transition: transform 0.2s; position: relative; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        .card-thumb { width: 100%; height: 200px; background: #f9f9f9; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .card-thumb img { width: 100%; height: 100%; object-fit: cover; }
        .no-thumb { font-size: 40px; color: #ddd; }
        .card-info { padding: 15px; }
        .card-title { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* ÊåâÈíÆÊ†∑Âºè */
        .delete-btn { position: absolute; top: 10px; right: 10px; background: rgba(255,0,0,0.8); color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; z-index: 2; }
        .card:hover .delete-btn { opacity: 1; }

        /* ÁΩÆÈ°∂ÊåâÈíÆ */
        .pin-btn { 
            position: absolute; top: 10px; left: 10px; 
            background: rgba(255,255,255,0.9); 
            color: #ccc; 
            border: 1px solid #ddd;
            width: 28px; height: 28px; border-radius: 50%; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
            z-index: 2; transition: all 0.2s;
        }
        .pin-btn:hover { background: #fff; color: #666; }
        /* ÊøÄÊ¥ªÁä∂ÊÄÅ */
        .pin-btn.active { background: #ff4757; color: white; border-color: #ff4757; box-shadow: 0 2px 8px rgba(255, 71, 87, 0.4); }

        #status { margin-top: 10px; color: #666; font-size: 14px; font-weight: 500; }
    </style>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <div class="upload-section">
            <h1>üèõÔ∏è Batch Asset Uploader</h1>
            <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                <div id="preview-canvas-container"></div>
                <div id="upload-text">
                    <span style="font-size: 40px;">üì¶</span><br>
                    <span id="fileName">Click to Select Multiple .glb Files</span>
                </div>
                <input type="file" id="fileInput" accept=".glb, .gltf" multiple style="display: none" onchange="handleFileSelect(this)">
            </div>
            
            <div class="progress-container" id="progressBox">
                <div id="progressLabel">Preparing...</div>
                <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressBar"></div></div>
                <div class="progress-text"><span id="progressCount">0/0</span><span id="progressPercent">0%</span></div>
            </div>

            <div id="status">Ready</div>
            <button class="btn-primary" id="saveBtn" onclick="processBatchUpload()" disabled>Upload All Files</button>
        </div>

        <div class="gallery-header">
            <h2>Collection Library</h2>
            <span id="count-badge" style="background:#eee; padding:5px 10px; border-radius:20px; font-size:12px;">Loading...</span>
        </div>
        <div class="grid" id="gallery-grid"></div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js'; 
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, query, orderBy, onSnapshot, updateDoc, getDocs, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // === Firebase Config ===
        const firebaseConfig = {
            apiKey: "AIzaSyAl_IaEOIKzrnulRN6j0pn0uN_aJFdAPOc",
            authDomain: "online-white-box.firebaseapp.com",
            projectId: "online-white-box",
            storageBucket: "online-white-box.firebasestorage.app",
            messagingSenderId: "227799896378",
            appId: "1:227799896378:web:94e416ee99d0e720e18003",
            measurementId: "G-G2ZWQZ8W8F"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let scene, camera, renderer, loader;
        
        window.handleFileSelect = handleFileSelect;
        window.processBatchUpload = processBatchUpload;
        window.deleteModel = deleteModel;
        window.togglePin = togglePin; // Êñ∞Â¢ûÁΩÆÈ°∂ÂáΩÊï∞

        let selectedFiles = [];
        
        initThreeJS();
        loadGalleryGrid();

        function initThreeJS() {
            const width = 150, height = 150;
            const container = document.getElementById('preview-canvas-container');
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf5f5f7);
            const ambient = new THREE.AmbientLight(0xffffff, 1.5);
            scene.add(ambient);
            const dirLight = new THREE.DirectionalLight(0xffffff, 2.0);
            dirLight.position.set(5, 10, 7);
            scene.add(dirLight);

            camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
            renderer.setSize(width, height);
            container.appendChild(renderer.domElement);

            loader = new GLTFLoader();
            const dracoLoader = new DRACOLoader();
            dracoLoader.setDecoderPath('https://unpkg.com/three@0.160.0/examples/jsm/libs/draco/');
            loader.setDRACOLoader(dracoLoader);
        }

        function handleFileSelect(input) {
            if (input.files && input.files.length > 0) {
                selectedFiles = Array.from(input.files);
                document.getElementById('fileName').innerText = `${selectedFiles.length} Files Selected`;
                document.getElementById('status').innerText = "Ready to start batch upload.";
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('saveBtn').innerText = `Upload ${selectedFiles.length} Files`;
                document.getElementById('upload-text').style.display = 'block';
                document.getElementById('preview-canvas-container').style.display = 'block';
            }
        }

        async function processBatchUpload() {
            if (selectedFiles.length === 0) return;
            const btn = document.getElementById('saveBtn');
            const status = document.getElementById('status');
            const pBox = document.getElementById('progressBox');
            const pBar = document.getElementById('progressBar');
            const pLabel = document.getElementById('progressLabel');
            const pCount = document.getElementById('progressCount');
            const pPercent = document.getElementById('progressPercent');

            btn.disabled = true;
            pBox.style.display = 'block';
            document.getElementById('upload-text').style.display = 'none';

            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < selectedFiles.length; i++) {
                const file = selectedFiles[i];
                const currentIndex = i + 1;
                const total = selectedFiles.length;

                pLabel.innerText = `Processing: ${file.name}`;
                pCount.innerText = `${currentIndex}/${total}`;
                const overallPercent = ((i / total) * 100).toFixed(0);
                pPercent.innerText = `${overallPercent}%`;
                pBar.style.width = `${overallPercent}%`;
                status.innerText = `Analyzing model ${currentIndex} of ${total}...`;

                try {
                    const thumbBlob = await generateThumbnailPromise(file);
                    status.innerText = `Uploading ${file.name}...`;
                    await uploadSingleFile(file, thumbBlob);
                    successCount++;
                } catch (err) {
                    console.error(`Failed to upload ${file.name}:`, err);
                    failCount++;
                }
            }

            pBar.style.width = '100%';
            pPercent.innerText = '100%';
            status.innerText = `üéâ Done! Success: ${successCount}, Failed: ${failCount}`;
            btn.innerText = "Upload Complete";
            setTimeout(() => { resetUI(); }, 3000);
        }

        function generateThumbnailPromise(file) {
            return new Promise((resolve, reject) => {
                const url = URL.createObjectURL(file);
                const oldModel = scene.children.find(c => c.type === 'Group' || c.type === 'Object3D');
                if(oldModel) scene.remove(oldModel);
                
                loader.load(url, (gltf) => {
                    const model = gltf.scene;
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());

                    model.position.x = -center.x;
                    model.position.y = -center.y;
                    model.position.z = -center.z;
                    scene.add(model);

                    const maxDim = Math.max(size.x, size.y, size.z);
                    const fov = camera.fov * (Math.PI / 180);
                    let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
                    cameraZ *= 1.5;
                    camera.position.set(0, size.y * 0.2, cameraZ);
                    camera.lookAt(0, 0, 0);

                    setTimeout(() => {
                        renderer.render(scene, camera);
                        renderer.domElement.toBlob((blob) => {
                            scene.remove(model);
                            URL.revokeObjectURL(url);
                            resolve(blob);
                        }, 'image/jpeg', 0.8);
                    }, 50);
                }, undefined, (err) => { resolve(null); });
            });
        }

        async function uploadSingleFile(file, thumbBlob) {
            const timestamp = Date.now();
            const randomId = Math.floor(Math.random() * 1000); 
            const modelName = `${timestamp}_${randomId}_${file.name}`;
            const thumbName = `${timestamp}_${randomId}_thumb.jpg`;

            const modelRef = ref(storage, 'library/' + modelName);
            const modelSnapshot = await uploadBytesResumable(modelRef, file);
            const modelUrl = await getDownloadURL(modelSnapshot.ref);

            let thumbUrl = null;
            let thumbPath = null;
            if (thumbBlob) {
                const thumbRef = ref(storage, 'library_thumbs/' + thumbName);
                const thumbSnapshot = await uploadBytesResumable(thumbRef, thumbBlob);
                thumbUrl = await getDownloadURL(thumbSnapshot.ref);
                thumbPath = thumbRef.fullPath;
            }

            await addDoc(collection(db, "model_library"), {
                name: file.name,
                url: modelUrl,
                thumbnailUrl: thumbUrl,
                thumbPath: thumbPath,
                storagePath: modelRef.fullPath,
                uploadDate: new Date(),
                active: true,
                pinned: false // ÈªòËÆ§‰∏çÁΩÆÈ°∂
            });
        }

        function resetUI() {
            selectedFiles = [];
            document.getElementById('fileName').innerText = "Click to Select Multiple .glb Files";
            document.getElementById('progressBox').style.display = 'none';
            document.getElementById('preview-canvas-container').style.display = 'none';
            document.getElementById('upload-text').style.display = 'block';
            document.getElementById('saveBtn').disabled = true;
            document.getElementById('saveBtn').innerText = "Upload All Files";
            document.getElementById('status').innerText = "Ready";
            document.getElementById('fileInput').value = '';
        }

        function loadGalleryGrid() {
            const grid = document.getElementById('gallery-grid');
            const q = query(collection(db, "model_library"), orderBy("uploadDate", "desc"));

            onSnapshot(q, (snapshot) => {
                grid.innerHTML = '';
                document.getElementById('count-badge').innerText = `${snapshot.size} items`;
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const card = document.createElement('div');
                    card.className = 'card';
                    
                    const thumbContent = data.thumbnailUrl ? `<img src="${data.thumbnailUrl}">` : `<div class="no-thumb">üßä</div>`;
                    
                    // ÁΩÆÈ°∂ÊåâÈíÆÁä∂ÊÄÅ
                    const pinClass = data.pinned ? 'active' : '';
                    const pinTitle = data.pinned ? 'Unpin' : 'Pin to Top';

                    card.innerHTML = `
                        <button class="pin-btn ${pinClass}" title="${pinTitle}" onclick="togglePin('${docSnap.id}', ${data.pinned})">üìå</button>
                        <button class="delete-btn" onclick="deleteModel('${docSnap.id}', '${data.storagePath}', '${data.thumbPath}')">√ó</button>
                        <div class="card-thumb">${thumbContent}</div>
                        <div class="card-info"><div class="card-title" title="${data.name}">${data.name}</div></div>
                    `;
                    grid.appendChild(card);
                });
            });
        }

        // === Êñ∞ÂäüËÉΩÔºöÊéí‰ªñÊÄßÁΩÆÈ°∂ÈÄªËæë ===
        async function togglePin(docId, currentStatus) {
            const batch = writeBatch(db);
            const isPinning = !currentStatus; // Â¶ÇÊûúÂΩìÂâçÊ≤°pinÔºåÈÇ£Â∞±ÊòØË¶Åpin

            if (isPinning) {
                // Â¶ÇÊûúÊòØÂéªÁΩÆÈ°∂ÔºåÂÖàÊääÂÖ∂‰ªñÊâÄÊúâÁöÑÈÉΩÂèñÊ∂àÁΩÆÈ°∂
                const pinnedQ = query(collection(db, "model_library"), where("pinned", "==", true));
                const pinnedDocs = await getDocs(pinnedQ);
                pinnedDocs.forEach(doc => {
                    batch.update(doc.ref, { pinned: false });
                });
                // ÁÑ∂ÂêéÊääÂΩìÂâçÁöÑËÆæ‰∏∫ true
                const currentRef = doc(db, "model_library", docId);
                batch.update(currentRef, { pinned: true });
            } else {
                // Â¶ÇÊûúÊòØÂèñÊ∂àÁΩÆÈ°∂ÔºåÁõ¥Êé•ËÆæ‰∏∫ false
                const currentRef = doc(db, "model_library", docId);
                batch.update(currentRef, { pinned: false });
            }

            await batch.commit();
        }

        async function deleteModel(docId, storagePath, thumbPath) {
            if (!confirm("Delete this model?")) return;
            try {
                await deleteDoc(doc(db, "model_library", docId));
                if (storagePath) await deleteObject(ref(storage, storagePath)).catch(e=>{});
                if (thumbPath) await deleteObject(ref(storage, thumbPath)).catch(e=>{});
            } catch (e) { alert(e.message); }
        }
    </script>
</body>
</html>