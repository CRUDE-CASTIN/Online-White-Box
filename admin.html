<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Gallery Library Admin</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; background: #f0f0f0; }
        .card { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; width: 400px; }
        h1 { margin-bottom: 30px; color: #333; }
        .file-box { border: 2px dashed #ccc; padding: 40px; border-radius: 8px; margin-bottom: 20px; cursor: pointer; transition: all 0.3s; }
        .file-box:hover { border-color: #666; background: #fafafa; }
        button { background: #000; color: white; border: none; padding: 15px 30px; border-radius: 30px; font-size: 16px; cursor: pointer; width: 100%; transition: transform 0.2s; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        #status { margin-top: 20px; color: #666; font-size: 14px; min-height: 20px; }
        .progress { width: 100%; height: 4px; background: #eee; margin-top: 10px; display:none; }
        .bar { height: 100%; background: #000; width: 0%; transition: width 0.2s; }
    </style>
</head>
<body>
    <div class="card">
        <h1>ðŸ“š Model Library System</h1>
        <div class="file-box" onclick="document.getElementById('fileInput').click()">
            <span id="fileName">Click to Select Model (.glb)</span>
            <input type="file" id="fileInput" accept=".glb, .gltf" style="display: none" onchange="handleFileSelect(this)">
        </div>
        <div class="progress" id="progressBox"><div class="bar" id="progressBar"></div></div>
        <button id="saveBtn" onclick="uploadToCloud()" disabled>Add to Library</button>
        <div id="status">Ready</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // === ä½ çš„é…ç½®å·²å¡«å…¥ ===
        const firebaseConfig = {
            apiKey: "AIzaSyAl_IaEOIKzrnulRN6j0pn0uN_aJFdAPOc",
            authDomain: "online-white-box.firebaseapp.com",
            projectId: "online-white-box",
            storageBucket: "online-white-box.firebasestorage.app",
            messagingSenderId: "227799896378",
            appId: "1:227799896378:web:94e416ee99d0e720e18003",
            measurementId: "G-G2ZWQZ8W8F"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        window.handleFileSelect = handleFileSelect;
        window.uploadToCloud = uploadToCloud;

        let selectedFile = null;

        function handleFileSelect(input) {
            if (input.files && input.files[0]) {
                selectedFile = input.files[0];
                document.getElementById('fileName').innerText = "Selected: " + selectedFile.name;
                document.getElementById('saveBtn').disabled = false;
                document.getElementById('status').innerText = "Ready to upload";
            }
        }

        async function uploadToCloud() {
            if (!selectedFile) return;
            const btn = document.getElementById('saveBtn');
            const status = document.getElementById('status');
            const pBox = document.getElementById('progressBox');
            const pBar = document.getElementById('progressBar');

            btn.disabled = true;
            pBox.style.display = 'block';

            // 1. ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å (æ—¶é—´æˆ³é˜²æ­¢é‡å)
            const uniqueName = Date.now() + '_' + selectedFile.name;
            const storageRef = ref(storage, 'library/' + uniqueName);
            const uploadTask = uploadBytesResumable(storageRef, selectedFile);

            uploadTask.on('state_changed', 
                (snapshot) => {
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    pBar.style.width = progress + '%';
                    status.innerText = `Uploading: ${Math.round(progress)}%`;
                }, 
                (error) => {
                    console.error(error);
                    status.innerText = "Error: " + error.message;
                    btn.disabled = false;
                }, 
                async () => {
                    status.innerText = "Saving to database...";
                    const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);

                    // 2. å°†è®°å½•ã€è¿½åŠ ã€‘åˆ°åº“ä¸­
                    try {
                        await addDoc(collection(db, "model_library"), {
                            name: selectedFile.name,
                            url: downloadURL,
                            uploadDate: new Date(),
                            active: true
                        });
                        status.innerText = "âœ… Successfully added to Library!";
                        btn.innerText = "Done";
                        
                        // é‡ç½®ç•Œé¢ä»¥ä¾¿ç»§ç»­ä¸Šä¼ 
                        setTimeout(() => {
                            selectedFile = null;
                            document.getElementById('fileName').innerText = "Click to Select Next Model";
                            pBox.style.display = 'none';
                            pBar.style.width = '0%';
                            btn.innerText = "Add to Library";
                            btn.disabled = true;
                            status.innerText = "Ready";
                        }, 2000);

                    } catch (e) {
                        console.error(e);
                        status.innerText = "Database Error";
                    }
                }
            );
        }
    </script>
</body>
</html>